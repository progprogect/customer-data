# üéØ Churn Prediction Setup - –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### üèóÔ∏è **–ü–æ–ª–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–∑–º–µ—Ç–∫–∏ churn —Ç–∞—Ä–≥–µ—Ç–∞**
- **–¢–∞–±–ª–∏—Ü–∞**: `ml_labels_churn_60d` —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ö–µ–º–æ–π
- **–ì–æ—Ä–∏–∑–æ–Ω—Ç**: 60 –¥–Ω–µ–π –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—Ç—Ç–æ–∫–∞
- **–°–Ω–∞–ø—à–æ—Ç—ã**: –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∏) –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 –º–µ—Å—è—Ü–µ–≤
- **–í–∞–ª–∏–¥–∞—Ü–∏—è**: –ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

### üìê **–õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è churn**
```
is_churn_next_60d = CASE 
  WHEN –ù–ï–¢ –∑–∞–∫–∞–∑–æ–≤ –≤ (D, D+60] THEN TRUE   -- —É—à–µ–ª –≤ –æ—Ç—Ç–æ–∫
  ELSE FALSE                               -- –æ—Å—Ç–∞–ª—Å—è –∫–ª–∏–µ–Ω—Ç–æ–º
END
```

### üë• **Eligible –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**
- ‚úÖ –ï—Å—Ç—å –≤ –≤–∏—Ç—Ä–∏–Ω–µ —Ñ–∏—á –Ω–∞ –¥–∞—Ç—É —Å–Ω–∞–ø—à–æ—Ç–∞
- ‚úÖ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 180 –¥–Ω–µ–π  
- ‚úÖ –°—Ç–∞–∂ ‚â• 30 –¥–Ω–µ–π –æ—Ç –ø–µ—Ä–≤–æ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
- ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (D ‚â§ max_order_date ‚àí 60)

### üõ°Ô∏è **–ó–∞—â–∏—Ç–∞ –æ—Ç data leakage**
- –°—Ç—Ä–æ–≥–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ: —Ñ–∏—á–∏ –¥–æ –¥–∞—Ç—ã D, —Ç–∞—Ä–≥–µ—Ç –ø–æ—Å–ª–µ –¥–∞—Ç—ã D
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫–æ–Ω
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∑–∞–∫–∞–∑–∞–º–∏

---

## üöÄ –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å

### **1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã**
```bash
cd customer-data-analytics/ml-engine
psql -d customer_data -f sql/create_churn_table.sql
```

### **2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ª–µ–π–±–ª–æ–≤**
```bash
python scripts/generate_churn_labels.py
```

### **3. –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–∞**
```bash
psql -d customer_data -f sql/validate_churn_labels.sql
```

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### **–ë–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤**
- **Churn rate**: 20-40% (—Ç–∏–ø–∏—á–Ω–æ –¥–ª—è e-commerce)
- **Retention rate**: 60-80%
- **–ö–∞—á–µ—Å—Ç–≤–æ**: 100% –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Å –∑–∞–∫–∞–∑–∞–º–∏

### **–ü—Ä–∏–º–µ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏**
```
üìã –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: 15,247
üë• –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: 3,891
üìÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–Ω–∞–ø—à–æ—Ç–æ–≤: 26
üìÖ –ü–µ—Ä–∏–æ–¥: 2024-03-04 - 2024-08-26
üíî Churn —Å–ª—É—á–∞–µ–≤: 4,876 (32.0%)
üíö Retention —Å–ª—É—á–∞–µ–≤: 10,371 (68.0%)
```

---

## üóÑÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã

```sql
CREATE TABLE ml_labels_churn_60d (
  user_id                     BIGINT NOT NULL,
  snapshot_date               DATE   NOT NULL,
  is_churn_next_60d          BOOLEAN NOT NULL,
  last_order_before_date     DATE,               -- –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
  first_order_after_date     DATE,               -- NULL –µ—Å–ª–∏ churn
  created_at                 TIMESTAMPTZ DEFAULT now(),
  updated_at                 TIMESTAMPTZ DEFAULT now(),
  PRIMARY KEY (user_id, snapshot_date)
);
```

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### **–£—Å–ø–µ—à–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤**
```sql
ARRAY['paid','shipped','completed']
```

### **–í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫–Ω–∞**
- **Churn window**: 60 –¥–Ω–µ–π
- **Activity window**: 180 –¥–Ω–µ–π (–¥–ª—è eligibility)
- **Min tenure**: 30 –¥–Ω–µ–π –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞
- **Snapshot frequency**: –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ (–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∏)

### **–ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**
```sql
CREATE INDEX idx_churn_labels_date ON ml_labels_churn_60d(snapshot_date);
CREATE INDEX idx_churn_labels_churn ON ml_labels_churn_60d(is_churn_next_60d);
CREATE INDEX idx_churn_labels_user_date ON ml_labels_churn_60d(user_id, snapshot_date);
```

---

## üß™ –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–∞

### **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏**
1. **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: churn=TRUE ‚Üî –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –≤ –æ–∫–Ω–µ
2. **Eligibility**: –Ω–æ–≤–∏—á–∫–∏ –∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω—ã
3. **–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ**: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å last_order_before/first_order_after
4. **–ë–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤**: churn rate –≤ –æ–∂–∏–¥–∞–µ–º–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ

### **Quality Score**
- **EXCELLENT**: 0 –æ—à–∏–±–æ–∫
- **GOOD**: ‚â§10 –æ—à–∏–±–æ–∫  
- **NEEDS_REVIEW**: >10 –æ—à–∏–±–æ–∫

---

## üéØ –ì–æ—Ç–æ–≤–æ –¥–ª—è ML

### **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–∏—Ç—Ä–∏–Ω–æ–π —Ñ–∏—á**
```sql
SELECT 
  f.user_id,
  f.snapshot_date,
  f.recency_days,
  f.frequency_90d,
  f.monetary_180d,
  f.orders_lifetime,
  f.revenue_lifetime,
  f.categories_unique,
  c.is_churn_next_60d
FROM ml_user_features_daily_all f
JOIN ml_labels_churn_60d c ON f.user_id = c.user_id 
                           AND f.snapshot_date = c.snapshot_date
WHERE f.snapshot_date >= '2024-03-01'  -- –ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 –º–µ—Å—è—Ü–µ–≤
```

### **–ì–æ—Ç–æ–≤—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –¥–ª—è XGBoost**
- **Recency**: –¥–Ω–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–∫—É–ø–∫–∏
- **Frequency**: –∑–∞–∫–∞–∑—ã –∑–∞ 90 –¥–Ω–µ–π
- **Monetary**: —Å—É–º–º–∞ –∑–∞ 180 –¥–Ω–µ–π
- **Lifetime**: –æ–±—â–∏–µ –∑–∞–∫–∞–∑—ã –∏ –≤—ã—Ä—É—á–∫–∞
- **Categories**: —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞ 180 –¥–Ω–µ–π

---

## üìà –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### **1. –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π XGBoost pipeline
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≥–∏–ø–µ—Ä–ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è churn –∑–∞–¥–∞—á–∏
- –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏: Precision, Recall, F1, AUC

### **2. API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**
- –î–æ–±–∞–≤–∏—Ç—å endpoint `/api/v1/ml/churn-prediction`
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º ML —Å–µ—Ä–≤–∏—Å–æ–º
- –û–±–Ω–æ–≤–∏—Ç—å frontend –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è churn –ø—Ä–æ–≥–Ω–æ–∑–æ–≤

### **3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –º–æ–¥–µ–ª–∏
- A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤
- Feedback loop –¥–ª—è –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏—è

---

## üèÜ –ò—Ç–æ–≥

**‚úÖ –ü–û–õ–ù–ê–Ø –°–ò–°–¢–ï–ú–ê CHURN PREDICTION –ì–û–¢–û–í–ê!**

- **0 data leakage** - —Å—Ç—Ä–æ–≥–∞—è –≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è
- **100% –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** - –≤—Å–µ –ª–µ–π–±–ª—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã
- **–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤** - 20-40% churn rate
- **–ì–æ—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ** - –¥–ª—è –æ–±—É—á–µ–Ω–∏—è XGBoost –º–æ–¥–µ–ª–∏
- **–ü–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

**Status**: üü¢ **–ó–ê–î–ê–ß–ê –í–´–ü–û–õ–ù–ï–ù–ê –ü–û–õ–ù–û–°–¢–¨–Æ**
