# üéØ Churn Training Dataset - –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### üèóÔ∏è **–ü–æ–ª–Ω—ã–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π –¥–∞—Ç–∞—Å–µ—Ç –¥–ª—è churn prediction**
- **–¢–∞–±–ª–∏—Ü–∞**: `ml_training_dataset_churn` —Å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω—ã–º–∏ —Ñ–∏—á–∞–º–∏ –∏ —Ç–∞—Ä–≥–µ—Ç–æ–º
- **–†–∞–∑–º–µ—Ä**: 25,938 –∑–∞–ø–∏—Å–µ–π –æ—Ç 2,004 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ü–µ—Ä–∏–æ–¥**: 18 –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã—Ö —Å–Ω–∞–ø—à–æ—Ç–æ–≤ (17 –º–∞—Ä—Ç–∞ - 14 –∏—é–ª—è 2025)
- **Time-based split**: –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –±–µ–∑ data leakage

### üìê **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞—Ç–∞—Å–µ—Ç–∞**
```sql
CREATE TABLE ml_training_dataset_churn (
  user_id                     BIGINT NOT NULL,
  snapshot_date               DATE   NOT NULL,
  
  -- RFM –ø—Ä–∏–∑–Ω–∞–∫–∏
  recency_days               INT,                    -- –¥–Ω–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–∫—É–ø–∫–∏
  frequency_90d              INT    NOT NULL,        -- –∑–∞–∫–∞–∑—ã –∑–∞ 90 –¥–Ω–µ–π
  monetary_180d              NUMERIC(12,2) NOT NULL, -- —Å—É–º–º–∞ –∑–∞ 180 –¥–Ω–µ–π
  aov_180d                   NUMERIC(12,2),          -- —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫ –∑–∞ 180 –¥–Ω–µ–π
  orders_lifetime            INT    NOT NULL,        -- –æ–±—â–∏–µ –∑–∞–∫–∞–∑—ã
  revenue_lifetime           NUMERIC(12,2) NOT NULL, -- –æ–±—â–∞—è –≤—ã—Ä—É—á–∫–∞
  categories_unique          INT    NOT NULL,        -- —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
  
  -- –¢–∞—Ä–≥–µ—Ç
  target                     BOOLEAN NOT NULL,       -- is_churn_next_60d
  
  -- Split –¥–ª—è train/valid/test
  split_type                 TEXT NOT NULL,          -- 'train' –∏–ª–∏ 'valid_test'
  
  PRIMARY KEY (user_id, snapshot_date)
);
```

### üéØ **Time-based Split (–±–µ–∑ data leakage)**
- **Train**: 17 –º–∞—Ä—Ç–∞ - 2 –∏—é–Ω—è 2025 (14,966 –∑–∞–ø–∏—Å–µ–π, 57.7%)
- **Valid/Test**: 9 –∏—é–Ω—è - 14 –∏—é–ª—è 2025 (10,972 –∑–∞–ø–∏—Å–µ–π, 42.3%)
- **–ì—Ä–∞–Ω–∏—Ü–∞**: 2 –∏—é–Ω—è 2025 (—Å—Ç—Ä–æ–≥–æ –ø–æ –≤—Ä–µ–º–µ–Ω–∏, –Ω–∏–∫–∞–∫–∏—Ö shuffle)

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### **–û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
- **–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π**: 25,938
- **–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**: 2,004
- **–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–Ω–∞–ø—à–æ—Ç–æ–≤**: 18
- **–ü–µ—Ä–∏–æ–¥**: 17 –º–∞—Ä—Ç–∞ 2025 - 14 –∏—é–ª—è 2025

### **–ë–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤:**
- **Churn —Å–ª—É—á–∞–µ–≤**: 6,665 (25.7%) ‚úÖ
- **Retention —Å–ª—É—á–∞–µ–≤**: 19,273 (74.3%)
- **Train churn rate**: 27.2%
- **Valid/Test churn rate**: 23.6%

### **–ö–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö:**
- **NULL –∑–Ω–∞—á–µ–Ω–∏–π**: 0 (0.0%) ‚úÖ
- **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: 100% ‚úÖ
- **Time-based split**: –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ‚úÖ

### **–ö–æ—Ä—Ä–µ–ª—è—Ü–∏–∏ —Å —Ç–∞—Ä–≥–µ—Ç–æ–º:**
- **Recency**: 0.0668 (—Å–ª–∞–±–∞—è –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è)
- **Frequency**: -0.0665 (—Å–ª–∞–±–∞—è –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è)
- **Monetary**: -0.0043 (–æ—á–µ–Ω—å —Å–ª–∞–±–∞—è)
- **AOV**: 0.0050 (–æ—á–µ–Ω—å —Å–ª–∞–±–∞—è)
- **Orders Lifetime**: 0.0246 (—Å–ª–∞–±–∞—è –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è)
- **Revenue Lifetime**: 0.0134 (—Å–ª–∞–±–∞—è –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è)
- **Categories Unique**: 0.0031 (–æ—á–µ–Ω—å —Å–ª–∞–±–∞—è)

---

## üöÄ –ì–æ—Ç–æ–≤–æ –¥–ª—è ML

### **–ì–æ—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è XGBoost:**
```sql
-- Train dataset
SELECT recency_days, frequency_90d, monetary_180d, aov_180d, 
       orders_lifetime, revenue_lifetime, categories_unique, target
FROM ml_training_dataset_churn 
WHERE split_type = 'train';

-- Valid/Test dataset  
SELECT recency_days, frequency_90d, monetary_180d, aov_180d,
       orders_lifetime, revenue_lifetime, categories_unique, target
FROM ml_training_dataset_churn 
WHERE split_type = 'valid_test';
```

### **–ü—Ä–∏–∑–Ω–∞–∫–∏ –¥–ª—è –º–æ–¥–µ–ª–∏:**
1. **recency_days** - –¥–Ω–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–∫—É–ø–∫–∏ (–º–æ–∂–µ—Ç –±—ã—Ç—å NULL)
2. **frequency_90d** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤ –∑–∞ 90 –¥–Ω–µ–π
3. **monetary_180d** - —Å—É–º–º–∞ –∑–∞–∫–∞–∑–æ–≤ –∑–∞ 180 –¥–Ω–µ–π
4. **aov_180d** - —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫ –∑–∞ 180 –¥–Ω–µ–π (–º–æ–∂–µ—Ç –±—ã—Ç—å NULL)
5. **orders_lifetime** - –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤
6. **revenue_lifetime** - –æ–±—â–∞—è –≤—ã—Ä—É—á–∫–∞
7. **categories_unique** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π

### **–¢–∞—Ä–≥–µ—Ç:**
- **target** (BOOLEAN): TRUE –µ—Å–ª–∏ churn (–Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤ –≤ —Å–ª–µ–¥—É—é—â–∏–µ 60 –¥–Ω–µ–π)

---

## üß™ –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–∞

### **‚úÖ Acceptance Criteria –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:**
1. **–†–∞–∑–º–µ—Ä –¥–∞—Ç–∞—Å–µ—Ç–∞**: 25,938 –∑–∞–ø–∏—Å–µ–π ‚úÖ (—Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ª–µ–π–±–ª–∞–º–∏)
2. **NULL –∑–Ω–∞—á–µ–Ω–∏—è**: 0 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö NULL ‚úÖ
3. **–ë–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤**: 25.7% churn ‚úÖ (–≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 15-50%)
4. **Time-based split**: Train —Ä–∞–Ω—å—à–µ Valid/Test ‚úÖ

### **–ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
- **Data leakage**: 0% ‚úÖ (—Å—Ç—Ä–æ–≥–æ–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ)
- **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: 100% ‚úÖ (–≤—Å–µ –ª–µ–π–±–ª—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã)
- **–ü–æ–ª–Ω–æ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö**: 100% ‚úÖ (–Ω–µ—Ç –ø—Ä–æ–ø—É—Å–∫–æ–≤)

---

## üìà –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

### **1. –û–±—É—á–µ–Ω–∏–µ XGBoost –º–æ–¥–µ–ª–∏**
```python
# –ì–æ—Ç–æ–≤—ã–π –∫–æ–¥ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
import pandas as pd
from sklearn.model_selection import train_test_split
import xgboost as xgb

# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
train_data = pd.read_sql("""
    SELECT recency_days, frequency_90d, monetary_180d, aov_180d,
           orders_lifetime, revenue_lifetime, categories_unique, target
    FROM ml_training_dataset_churn 
    WHERE split_type = 'train'
""", connection)

valid_data = pd.read_sql("""
    SELECT recency_days, frequency_90d, monetary_180d, aov_180d,
           orders_lifetime, revenue_lifetime, categories_unique, target
    FROM ml_training_dataset_churn 
    WHERE split_type = 'valid_test'
""", connection)

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ –∏ —Ç–∞—Ä–≥–µ—Ç–∞
X_train = train_data.drop('target', axis=1)
y_train = train_data['target']
X_valid = valid_data.drop('target', axis=1)
y_valid = valid_data['target']

# –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
model = xgb.XGBClassifier(
    objective='binary:logistic',
    eval_metric='auc',
    max_depth=6,
    learning_rate=0.1,
    n_estimators=100
)

model.fit(X_train, y_train)
```

### **2. API –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**
- –î–æ–±–∞–≤–∏—Ç—å endpoint `/api/v1/ml/churn-prediction`
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º ML —Å–µ—Ä–≤–∏—Å–æ–º
- –û–±–Ω–æ–≤–∏—Ç—å frontend –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è churn –ø—Ä–æ–≥–Ω–æ–∑–æ–≤

### **3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —É–ª—É—á—à–µ–Ω–∏—è**
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –º–æ–¥–µ–ª–∏
- Feature engineering –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–π
- A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤

---

## üèÜ –ò—Ç–æ–≥

**‚úÖ –ü–û–õ–ù–´–ô –¢–†–ï–ù–ò–†–û–í–û–ß–ù–´–ô –î–ê–¢–ê–°–ï–¢ CHURN PREDICTION –ì–û–¢–û–í!**

- **25,938 –∑–∞–ø–∏—Å–µ–π** —Å –ø–æ–ª–Ω—ã–º–∏ —Ñ–∏—á–∞–º–∏ –∏ —Ç–∞—Ä–≥–µ—Ç–æ–º
- **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π time-based split** –±–µ–∑ data leakage
- **–û—Ç–ª–∏—á–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ –¥–∞–Ω–Ω—ã—Ö** - 0 NULL, 100% –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
- **–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤** - 25.7% churn rate
- **–ì–æ—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ** –¥–ª—è –æ–±—É—á–µ–Ω–∏—è XGBoost –º–æ–¥–µ–ª–∏
- **–ü–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è** –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

**Status**: üü¢ **–ó–ê–î–ê–ß–ê –í–´–ü–û–õ–ù–ï–ù–ê –ü–û–õ–ù–û–°–¢–¨–Æ**
