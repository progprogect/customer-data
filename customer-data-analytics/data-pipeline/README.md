# Data Pipeline

Генерация и загрузка тестовых данных для системы Customer Data Analytics.

## Описание

Этот модуль содержит инструменты для создания реалистичных тестовых данных и их загрузки в PostgreSQL базу данных.

## Файлы

- `generate_data.py` - генератор тестовых данных
- `load_data.py` - загрузчик данных в БД
- `requirements.txt` - зависимости

## Быстрый старт

### 1. Генерация данных

```bash
cd data-pipeline
python generate_data.py
```

Это создаст директорию `seed/` с CSV файлами и SQL скриптами.

### 2. Загрузка в базу данных

```bash
python load_data.py
```

Или вручную:

```bash
psql -d customer_data -f seed/01_categories.sql
psql -d customer_data -f seed/00_copy.sql
```

### 3. Валидация данных

```bash
psql -d customer_data -f seed/99_validate.sql
```

## Конфигурация

В файле `generate_data.py` можно настроить параметры генерации:

```python
CONFIG = {
    "CATEGORIES_N": 12,        # Количество категорий
    "PRODUCTS_N": 1000,        # Количество товаров
    "USERS_N": 3000,          # Количество пользователей
    "ORDERS_N": 20000,        # Количество заказов
    "EVENTS_APPROX": 120000,   # Примерное количество событий
    "MONTHS_HISTORY": 12,      # История в месяцах
    "PRICE_STEP": "week",      # Шаг изменения цен
    "CURRENCY": "USD",         # Валюта
}
```

## Структура данных

### Генерируемые данные

1. **Категории товаров** - 12 категорий с ценовыми диапазонами
2. **Товары** - 1000 товаров с реалистичными характеристиками
3. **История цен** - еженедельные изменения цен с сезонностью
4. **Пользователи** - 3000 пользователей из разных стран
5. **Заказы** - 20000 заказов с корректными связями
6. **События** - события поведения пользователей

### Особенности данных

- **Детерминированность** - одинаковые данные при каждом запуске (SEED=42)
- **Реалистичность** - правдоподобные паттерны поведения
- **Связность** - корректные связи между таблицами
- **Сезонность** - промо-акции в ноябре-декабре
- **Сегментация** - разные типы пользователей (power, normal, low)

## Валидация

Скрипт `99_validate.sql` проверяет:

1. Корректность сумм заказов
2. Отсутствие событий до регистрации
3. Наличие цен на дату заказа
4. Реалистичность конверсии (5-40%)

## Масштабирование

Для увеличения объема данных измените параметры в `CONFIG`:

- **Малый объем**: `PRODUCTS_N=100, USERS_N=500, ORDERS_N=2000`
- **Средний объем**: `PRODUCTS_N=1000, USERS_N=3000, ORDERS_N=20000` (по умолчанию)
- **Большой объем**: `PRODUCTS_N=10000, USERS_N=50000, ORDERS_N=200000`

## Troubleshooting

### Ошибка подключения к БД

Убедитесь, что PostgreSQL запущен и база данных создана:

```bash
createdb customer_data
```

### Ошибка psql

Убедитесь, что PostgreSQL установлен и добавлен в PATH:

```bash
which psql
```

### Недостаточно памяти

Уменьшите параметры в `CONFIG` или используйте потоковую обработку.

## Примеры использования

### Генерация данных для тестирования

```bash
# Быстрая генерация для тестов
python -c "
import sys
sys.path.append('.')
from generate_data import *
CONFIG['PRODUCTS_N'] = 100
CONFIG['USERS_N'] = 500
CONFIG['ORDERS_N'] = 2000
main()
"
```

### Загрузка только определенных таблиц

```bash
# Только товары и пользователи
psql -d customer_data -f seed/01_categories.sql
psql -d customer_data -c "\\copy products FROM 'seed/02_products.csv' CSV HEADER NULL 'NULL';"
psql -d customer_data -c "\\copy users FROM 'seed/04_users.csv' CSV HEADER NULL 'NULL';"
```

