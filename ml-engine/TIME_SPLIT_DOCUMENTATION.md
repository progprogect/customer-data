# üìä Time-based Split Documentation

## üéØ –û–±–∑–æ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑—Ä–µ–∑–∞

–î–∞—Ç–∞—Å–µ—Ç `ml_training_dataset` —Ä–∞–∑–¥–µ–ª–µ–Ω –Ω–∞ train/valid/test —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º **—Å—Ç—Ä–æ–≥–æ–≥–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑—Ä–µ–∑–∞** –±–µ–∑ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è –¥–ª—è —á–µ—Å—Ç–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ ML –º–æ–¥–µ–ª–∏.

---

## üìÖ –ì—Ä–∞–Ω–∏—Ü—ã —Å–ø–ª–∏—Ç–æ–≤

### **Train Set (73.9%)**
- **–î–∞—Ç—ã:** 2025-03-17 ‚Üí 2025-07-07
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–¥–µ–ª—å:** 17
- **–°—Ç—Ä–æ–∫:** 51,000
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** 3,000 (–∑–∞ –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é)

### **Valid Set (13.0%)**
- **–î–∞—Ç—ã:** 2025-07-14 ‚Üí 2025-07-28
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–¥–µ–ª—å:** 3
- **–°—Ç—Ä–æ–∫:** 9,000
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** 3,000 (–∑–∞ –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é)

### **Test Set (13.0%)**
- **–î–∞—Ç—ã:** 2025-08-04 ‚Üí 2025-08-18
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–¥–µ–ª—å:** 3
- **–°—Ç—Ä–æ–∫:** 9,000
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:** 3,000 (–∑–∞ –∫–∞–∂–¥—É—é –Ω–µ–¥–µ–ª—é)

---

## üéØ –ë–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤

| **–°–ø–ª–∏—Ç** | **Positive Rate** | **Positive Count** | **Negative Count** |
|-----------|-------------------|--------------------|--------------------|
| **Train** | **38.87%** | 19,822 | 31,178 |
| **Valid** | **56.99%** | 5,129 | 3,871 |
| **Test** | **64.02%** | 5,762 | 3,238 |

### ‚ö†Ô∏è **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –¥–∏—Å–±–∞–ª–∞–Ω—Å–µ:**
- Valid –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç Train –Ω–∞ **+18.1 –ø.–ø.**
- Test –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç Train –Ω–∞ **+25.2 –ø.–ø.**

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:** –≠—Ç–æ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–∞—è —ç–≤–æ–ª—é—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ ‚Äî –±–æ–ª–µ–µ –ø–æ–∑–¥–Ω–∏–µ –ø–µ—Ä–∏–æ–¥—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –ø–æ–≤—ã—à–µ–Ω–Ω—É—é –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å, —Ä–æ—Å—Ç –±–∏–∑–Ω–µ—Å–∞).

---

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ñ–∏—á–µ–π –ø–æ —Å–ø–ª–∏—Ç–∞–º

| **–§–∏—á–∞** | **Train** | **Valid** | **Test** | **–¢—Ä–µ–Ω–¥** |
|----------|-----------|-----------|----------|-----------|
| **Recency (–¥–Ω–∏)** | 35.2 | 34.5 | 32.9 | ‚Üì –£–º–µ–Ω—å—à–∞–µ—Ç—Å—è |
| **Frequency (90–¥)** | 1.2 | 1.9 | 2.3 | ‚Üë –†–∞—Å—Ç–µ—Ç |
| **Monetary (180–¥)** | $1,133 | $1,964 | $2,342 | ‚Üë –†–∞—Å—Ç–µ—Ç |

**–í—ã–≤–æ–¥:** –í–∏–¥–Ω–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–Ω–∞–º–∏–∫–∞ –±–∏–∑–Ω–µ—Å–∞ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–∫—É–ø–∞—é—Ç —á–∞—â–µ –∏ —Ç—Ä–∞—Ç—è—Ç –±–æ–ª—å—à–µ –≤ –±–æ–ª–µ–µ –ø–æ–∑–¥–Ω–∏–µ –ø–µ—Ä–∏–æ–¥—ã.

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–∞–∑—Ä–µ–∑–∞

### **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (PASSED):**
- ‚úÖ **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π:** –ù–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è (user_id, snapshot_date) –º–µ–∂–¥—É —Å–ø–ª–∏—Ç–∞–º–∏
- ‚úÖ **–í—Ä–µ–º–µ–Ω–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** Train < Valid < Test (–±–µ–∑ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–π –¥–∞—Ç)
- ‚úÖ **–î–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã:** Valid/Test >5K —Å—Ç—Ä–æ–∫ –∫–∞–∂–¥—ã–π

### **–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è (–¥–ª—è —É—á–µ—Ç–∞ –ø—Ä–∏ –æ–±—É—á–µ–Ω–∏–∏):**
- ‚ö†Ô∏è **–î–∏—Å–±–∞–ª–∞–Ω—Å –∫–ª–∞—Å—Å–æ–≤:** Valid/Test –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –æ—Ç Train
- ‚ö†Ô∏è **–≠–≤–æ–ª—é—Ü–∏—è —Ñ–∏—á–µ–π:** –ó–∞–º–µ—Ç–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ frequency –∏ monetary –º–µ–∂–¥—É –ø–µ—Ä–∏–æ–¥–∞–º–∏

---

## üõ†Ô∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### **SQL —Å–æ–∑–¥–∞–Ω–∏—è —Å–ø–ª–∏—Ç–æ–≤:**
```sql
-- –ì—Ä–∞–Ω–∏—Ü—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
-- 70% –æ—Ç 23 –¥–∞—Ç = 17 –¥–∞—Ç (train)
-- 15% –æ—Ç 23 –¥–∞—Ç = 3 –¥–∞—Ç—ã (valid)
-- 15% –æ—Ç 23 –¥–∞—Ç = 3 –¥–∞—Ç—ã (test)

UPDATE ml_training_dataset 
SET split = CASE 
  WHEN snapshot_date >= '2025-03-17' AND snapshot_date <= '2025-07-07' THEN 'train'
  WHEN snapshot_date >= '2025-07-14' AND snapshot_date <= '2025-07-28' THEN 'valid'  
  WHEN snapshot_date >= '2025-08-04' AND snapshot_date <= '2025-08-18' THEN 'test'
END;
```

### **–î–æ—Å—Ç—É–ø –∫ —Å–ø–ª–∏—Ç–∞–º:**
```sql
-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã —Å —Ñ–∏–ª—å—Ç—Ä–æ–º
SELECT * FROM ml_training_dataset WHERE split = 'train';

-- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
SELECT * FROM ml_train_set;
SELECT * FROM ml_valid_set;
SELECT * FROM ml_test_set;
```

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏

### **1. –£—á–µ—Ç —ç–≤–æ–ª—é—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **temporally-aware validation** ‚Äî –º–æ–¥–µ–ª—å –¥–æ–ª–∂–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ –Ω–∞ –±–æ–ª–µ–µ –ø–æ–∑–¥–Ω–∏—Ö –ø–µ—Ä–∏–æ–¥–∞—Ö
- –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å **time-based features** (—Ç—Ä–µ–Ω–¥—ã, —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å)

### **2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∏—Å–±–∞–ª–∞–Ω—Å–∞:**
- **–ù–ï –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞—Ç—å** valid/test –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ ‚Äî —ç—Ç–æ –æ—Ç—Ä–∞–∂–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é —ç–≤–æ–ª—é—Ü–∏—é
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **stratified sampling** —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ train –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
- –ü—Ä–∏–º–µ–Ω–∏—Ç—å **class_weight** –∏–ª–∏ **scale_pos_weight** –≤ XGBoost

### **3. –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:**
- –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç—Ä–∏–∫–æ–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **performance –Ω–∞ test set**
- Valid set –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è **hyperparameter tuning**
- –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å **performance drift** –º–µ–∂–¥—É —Å–ø–ª–∏—Ç–∞–º–∏

### **4. –ü—Ä–æ–¥–∞–∫—à–Ω –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å:**
- –ú–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–Ω–∞—è –Ω–∞ train –¥–æ 2025-07-07 –≥–æ—Ç–æ–≤–∞ –¥–ª—è –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π —Å 2025-08-04
- –í—Ä–µ–º–µ–Ω–Ω–æ–π —Ä–∞–∑—Ä—ã–≤ –≤ 4 –Ω–µ–¥–µ–ª–∏ –º–æ–¥–µ–ª–∏—Ä—É–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

---

## üìä –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å

### **–í–µ—Ä—Å–∏—è –¥–∞–Ω–Ω—ã—Ö:**
- **–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-09-19
- **–ë–∞–∑–æ–≤—ã–π –¥–∞—Ç–∞—Å–µ—Ç:** ml_training_dataset (69,000 —Å—Ç—Ä–æ–∫)
- **–ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–∑—Ä–µ–∑–∞:** 70/15/15 –ø–æ snapshot_date –±–µ–∑ –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è

### **–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:**
```bash
# 1. –†–∞—Å—á–µ—Ç –≥—Ä–∞–Ω–∏—Ü
psql -d customer_data -f calculate_time_split_boundaries.sql

# 2. –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–ª–∏—Ç–æ–≤
psql -d customer_data -f add_time_based_split.sql

# 3. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
psql -d customer_data -f create_split_views.sql

# 4. –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–∞
psql -d customer_data -f validate_time_split_quality.sql
```

---

## üéâ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–í—Ä–µ–º–µ–Ω–Ω–æ–π —Ä–∞–∑—Ä–µ–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –≥–æ—Ç–æ–≤ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è XGBoost –º–æ–¥–µ–ª–∏.**

–û—Å–Ω–æ–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:
- ‚úÖ **–ß–µ—Å—Ç–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è** ‚Äî —Å—Ç—Ä–æ–≥–æ–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ
- ‚úÖ **–ü—Ä–æ–¥–∞–∫—à–Ω-–≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å** ‚Äî –º–æ–¥–µ–ª–∏—Ä—É–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è
- ‚úÖ **–î–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã** ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏ –∑–Ω–∞—á–∏–º—ã–µ valid/test –Ω–∞–±–æ—Ä—ã
- ‚ö†Ô∏è **–≠–≤–æ–ª—é—Ü–∏—è –±–∏–∑–Ω–µ—Å–∞** ‚Äî —É—á—Ç–µ–Ω–∞ –≤ –¥–∏—Å–±–∞–ª–∞–Ω—Å–µ –∫–ª–∞—Å—Å–æ–≤

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –û–±—É—á–µ–Ω–∏–µ XGBoost –º–æ–¥–µ–ª–∏ —Å —É—á–µ—Ç–æ–º –≤—ã—è–≤–ª–µ–Ω–Ω—ã—Ö –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–µ–π –¥–∞–Ω–Ω—ã—Ö.
